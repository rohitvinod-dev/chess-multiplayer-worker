import type { CreateLobbyRequest, LobbyInfo, LobbySettings } from '../../types/lobby';

/**
 * POST /api/lobby/create
 *
 * Create a new lobby for custom games
 */
export async function createLobbyHandler(
  request: Request,
  env: any,
  userId: string
): Promise<Response> {
  try {
    const body = await request.json() as CreateLobbyRequest;

    // Validate input
    if (!body.creatorDisplayName || !body.settings) {
      return new Response(JSON.stringify({
        error: 'Missing required fields',
      }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' },
      });
    }

    // Validate settings
    const settings = body.settings;
    if (!['blitz', 'rapid', 'classical'].includes(settings.gameMode)) {
      return new Response(JSON.stringify({
        error: 'Invalid game mode',
      }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' },
      });
    }

    if (!['white', 'black', 'random'].includes(settings.playerColor)) {
      return new Response(JSON.stringify({
        error: 'Invalid player color',
      }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' },
      });
    }

    // Generate unique lobby ID
    const lobbyId = crypto.randomUUID();

    // Determine creator's color
    let creatorColor: 'white' | 'black';
    if (settings.playerColor === 'random') {
      creatorColor = Math.random() < 0.5 ? 'white' : 'black';
    } else {
      creatorColor = settings.playerColor as 'white' | 'black';
    }

    // Generate private code if needed
    let privateCode: string | undefined;
    if (settings.isPrivate) {
      privateCode = Math.floor(100000 + Math.random() * 900000).toString();
    }

    // Set default spectator limit
    if (!settings.maxSpectators) {
      settings.maxSpectators = 50;
    }

    // Create lobby info
    const lobby: LobbyInfo = {
      id: lobbyId,
      creatorId: userId,
      creatorDisplayName: body.creatorDisplayName,
      creatorRating: body.creatorRating || 1200,
      settings: {
        ...settings,
        privateCode,
      },
      status: 'waiting',
      createdAt: Date.now(),
      gameRoomId: lobbyId, // Use same ID for game room
      spectatorCount: 0,
      spectatorIds: [],
    };

    // Set creator as player based on color
    if (creatorColor === 'white') {
      lobby.whitePlayerId = userId;
      lobby.whiteDisplayName = body.creatorDisplayName;
      lobby.whiteRating = body.creatorRating || 1200;
    } else {
      lobby.blackPlayerId = userId;
      lobby.blackDisplayName = body.creatorDisplayName;
      lobby.blackRating = body.creatorRating || 1200;
    }

    // Get LobbyList Durable Object (single global instance)
    const lobbyListId = env.LOBBY_LIST.idFromName('global');
    const lobbyListStub = env.LOBBY_LIST.get(lobbyListId);

    // Add lobby to list
    await lobbyListStub.fetch(new Request('https://lobby-list/add', {
      method: 'POST',
      body: JSON.stringify(lobby),
      headers: { 'Content-Type': 'application/json' },
    }));

    // Generate WebSocket URL for game room
    const protocol = new URL(request.url).protocol === 'https:' ? 'wss:' : 'ws:';
    const host = request.headers.get('host') || 'localhost';

    lobby.webSocketUrl = `${protocol}//${host}/game/${lobbyId}?` +
      `playerId=${userId}&` +
      `displayName=${encodeURIComponent(body.creatorDisplayName)}&` +
      `rating=${body.creatorRating || 1200}&` +
      `color=${creatorColor}&` +
      `mode=lobby&` +
      `isUnrated=true`;

    // Add opening parameters if specified
    if (settings.openingId) {
      lobby.webSocketUrl += `&openingId=${settings.openingId}`;
      if (settings.openingName) {
        lobby.webSocketUrl += `&openingName=${encodeURIComponent(settings.openingName)}`;
      }
      if (settings.openingFen) {
        lobby.webSocketUrl += `&openingFen=${encodeURIComponent(settings.openingFen)}`;
      }
    }

    console.log(`Created lobby ${lobbyId} for user ${userId}`);

    return new Response(JSON.stringify({
      lobby,
      creatorColor,
    }), {
      status: 201,
      headers: { 'Content-Type': 'application/json' },
    });
  } catch (error) {
    console.error('Error creating lobby:', error);
    return new Response(JSON.stringify({
      error: 'Failed to create lobby',
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    });
  }
}
